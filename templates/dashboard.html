{% extends "base.html" %}

{% block title %}Dashboard - {{ doctor.hospital_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Hero Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="welcome-header">
                <div class="row align-items-center">
                    <div class="col-12 text-center">
                        <h1 class="display-5 fw-bold mb-2">Welcome, {{ doctor.hospital_name }}</h1>
                        <p class="lead text-muted mb-0">Manage your veterinary pharmacy with ease</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Farmer Search Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">Find Farmer by Mobile Number</h5>
                    <form id="farmerSearchForm" action="{{ url_for('search_farmer') }}" method="POST">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="mobile_no" name="mobile_no" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" required>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-search me-2"></i>Find Farmer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">Quick Actions</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('medicine') }}" class="btn btn-outline-success">
                            <i class="fas fa-pills me-2"></i>Medicine Recommendation
                        </a>
                        <a href="#" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addFarmerModal">
                            <i class="fas fa-user-plus me-2"></i>New Farmer
                        </a>
                        <a href="{{ url_for('analytics') }}" class="btn btn-outline-success">
                            <i class="fas fa-chart-bar me-2"></i>View Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Cards -->
    <div class="row">
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="dashboard-icon-container me-3">
                            <i class="fas fa-store-alt dashboard-icon text-success"></i>
                        </div>
                        <h5 class="card-title mb-0">Shop Information</h5>
                    </div>
                    <p class="card-text">View and update your shop details and preferences</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#shopInfoModal">
                        View Details
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="dashboard-icon-container me-3">
                            <i class="fas fa-pills dashboard-icon text-success"></i>
                        </div>
                        <h5 class="card-title mb-0">Medicine Recommendations</h5>
                    </div>
                    <p class="card-text">Create and view medicine dosage recommendations</p>
                    <a href="#" onclick="checkFarmerNumber(event)" class="btn btn-success">
                        Manage Recommendations
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="dashboard-icon-container me-3">
                            <i class="fas fa-chart-line dashboard-icon text-info"></i>
                        </div>
                        <h5 class="card-title mb-0">Analytics</h5>
                    </div>
                    <p class="card-text">View sales and performance reports for your shop</p>
                    <a href="{{ url_for('analytics') }}" class="btn btn-success">
                        View Analytics
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="dashboard-icon-container me-3">
                            <i class="fas fa-users dashboard-icon text-warning"></i>
                        </div>
                        <h5 class="card-title mb-0">Farmers</h5>
                    </div>
                    <p class="card-text">Manage farmer and customer information</p>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addFarmerModal">
                        Add New Farmer
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card dashboard-card h-100 border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="dashboard-icon-container me-3">
                            <i class="fas fa-cog dashboard-icon text-dark"></i>
                        </div>
                        <h5 class="card-title mb-0">Settings</h5>
                    </div>
                    <p class="card-text">Configure shop settings and preferences</p>
                    <a href="{{ url_for('settings') }}" class="btn btn-success">
                        Settings
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shop Information Modal -->
<div class="modal fade" id="shopInfoModal" tabindex="-1" aria-labelledby="shopInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shopInfoModalLabel">Shop Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Shop Name:</label>
                    <p>{{ doctor.hospital_name }}</p>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Owner Name:</label>
                    <p>{{ doctor.doctor_name }}</p>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Mobile Number:</label>
                    <p>{{ doctor.mobile_no }}</p>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Email:</label>
                    <p>{{ doctor.email or 'Not provided' }}</p>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Address:</label>
                    <p>{{ doctor.address or 'Not provided' }}</p>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Registration Date:</label>
                    <p>{{ doctor.created_at.strftime('%d %B, %Y') }}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">Close</button>
                <a href="{{ url_for('settings') }}" class="btn btn-success">Edit Information</a>
            </div>
        </div>
    </div>
</div>

<!-- Add Farmer Modal -->
<div class="modal fade" id="addFarmerModal" tabindex="-1" aria-labelledby="addFarmerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFarmerModalLabel">Add New Farmer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('add_farmer') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="farmer_name" class="form-label">Farmer Name</label>
                        <input type="text" class="form-control" id="farmer_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="farmer_mobile" class="form-label">Mobile Number</label>
                        <input type="text" class="form-control" id="farmer_mobile" name="mobile_no" pattern="[0-9]{10}" required>
                        <div class="form-text">10-digit mobile number</div>
                    </div>
                    <div class="mb-3">
                        <label for="farmer_address" class="form-label">Address</label>
                        <textarea class="form-control" id="farmer_address" name="address" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="farmer_pincode" class="form-label">Pincode</label>
                        <input type="text" class="form-control" id="farmer_pincode" name="pincode" pattern="[0-9]{6}">
                        <div class="form-text">6-digit pincode</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Farmer</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Farmer search form submission via AJAX
        const farmerSearchForm = document.getElementById('farmerSearchForm');
        const addFarmerModal = new bootstrap.Modal(document.getElementById('addFarmerModal'));
        
        if (farmerSearchForm) {
            farmerSearchForm.addEventListener('submit', function(event) {
                const mobileInput = document.getElementById('mobile_no');
                
                if (!/^\d{10}$/.test(mobileInput.value)) {
                    event.preventDefault();
                    alert('Please enter a valid 10-digit mobile number');
                    mobileInput.focus();
                    return;
                }
                
                // Prevent default form submission and use AJAX instead
                event.preventDefault();
                
                // Create FormData object from the form
                const formData = new FormData(farmerSearchForm);
                
                // Send AJAX request
                fetch(farmerSearchForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'not_found') {
                        // Pre-fill the mobile number in the add farmer form
                        document.getElementById('farmer_mobile').value = data.mobile_no;
                        
                        // Show the add farmer modal
                        addFarmerModal.show();
                    } else {
                        // If the response is not JSON, it's a redirect, so follow it
                        window.location.href = data.redirect || window.location.href;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // In case of error, submit the form normally
                    farmerSearchForm.submit();
                });
            });
        }
        
        // If mobile_no is provided in URL query params, show add farmer modal
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('add_farmer') === 'True' && urlParams.get('mobile_no')) {
            document.getElementById('farmer_mobile').value = urlParams.get('mobile_no');
            addFarmerModal.show();
        }


    });
</script>
{% endblock %}
